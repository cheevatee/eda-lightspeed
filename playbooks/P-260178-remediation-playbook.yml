- name: Fix BackOff event for redhat-marketplace-m72m8
  hosts: localhost
  gather_facts: false
  tasks:

    - name: Gather pods for the workload
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-marketplace
        label_selectors:
          - app=redhat-marketplace-m72m8
      register: pod_info

    - name: Identify pods with backoff
      set_fact:
        backoff_pods: "{{ backoff_pods | default([]) + [item.metadata.name] }}"
      loop: "{{ pod_info.resources }}"
      when: >
        (item.status.containerStatuses | selectattr('state.waiting', 'defined') |
         map(attribute='state.waiting.reason') | list | intersect(['ImagePullBackOff', 'CrashLoopBackOff'])) | length > 0

    - name: Delete pods in backoff
      kubernetes.core.k8s:
        state: absent
        kind: Pod
        namespace: openshift-marketplace
        name: "{{ item }}"
      loop: "{{ backoff_pods }}"
      when: backoff_pods is defined and backoff_pods | length > 0

    - name: Gather deployment definition
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: openshift-marketplace
        name: redhat-marketplace-m72m8
      register: deployment_info

    - name: Set deployment spec
      set_fact:
        deployment_spec: "{{ deployment_info.resources[0].spec }}"

    - name: Set deployment definition with restart annotation
      set_fact:
        deployment_def:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: redhat-marketplace-m72m8
            namespace: openshift-marketplace
            annotations:
              redeploy-timestamp: "{{ lookup('pipe', 'date +%s') }}"
          spec: "{{ deployment_spec }}"

    - name: Restart deployment
      kubernetes.core.k8s:
        state: present
        definition: "{{ deployment_def }}"

    - name: Wait for pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-marketplace
        label_selectors:
          - app=redhat-marketplace-m72m8
      register: pod_info_wait
      until: >
        pod_info_wait.resources | map(attribute='status.containerStatuses') | flatten |
        map(attribute='ready') | list | all
      retries: 30
      delay: 10

    - name: Verify no backoff events remain
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-marketplace
        label_selectors:
          - app=redhat-marketplace-m72m8
      register: pod_info_verify

    - name: Fail if any pod still in backoff
      fail:
        msg: "Pods still in backoff state"
      when: >
        pod_info_verify.resources | map(attribute='status.containerStatuses') | flatten |
        map(attribute='state.waiting.reason') | list | intersect(['ImagePullBackOff', 'CrashLoopBackOff']) | length > 0
---
- name: Fix BackOff event for redhat-marketplace-98fsc
  hosts: localhost
  gather_facts: no
  tasks:

    - name: Gather pods for the workload
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-marketplace
        label_selectors:
          - app=redhat-marketplace-98fsc
      register: pod_info

    - name: Identify pods needing restart
      set_fact:
        pods_to_restart: "{{ pods_to_restart | default([]) + [item.metadata.name] }}"
      loop: "{{ pod_info.resources }}"
      when: >
        item.status.phase in ['Failed', 'Pending'] or
        (item.status.containerStatuses | selectattr('state.waiting.reason', 'in', ['ImagePullBackOff', 'CrashLoopBackOff']) | list | length > 0)

    - name: Delete problematic pods
      kubernetes.core.k8s:
        state: absent
        kind: Pod
        namespace: openshift-marketplace
        name: "{{ item }}"
      loop: "{{ pods_to_restart }}"
      when: pods_to_restart | length > 0

    - name: Wait for all pods to be Running
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-marketplace
        label_selectors:
          - app=redhat-marketplace-98fsc
      register: pod_status
      retries: 10
      delay: 15
      until: >
        pod_status.resources | map(attribute='status.phase') | list | unique | length == 1 and
        pod_status.resources | map(attribute='status.phase') | list | first == 'Running'

    - name: Verify no pods in backoff
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-marketplace
        label_selectors:
          - app=redhat-marketplace-98fsc
      register: final_pods
      failed_when: >
        (final_pods.resources | selectattr('status.phase', 'in', ['Failed', 'Pending']) | list | length > 0) or
        (final_pods.resources | selectattr('status.containerStatuses', 'search', 'ImagePullBackOff') | list | length > 0) or
        (final_pods.resources | selectattr('status.containerStatuses', 'search', 'CrashLoopBackOff') | list | length > 0)
---
- name: Fix and verify low disk space on PVC
  hosts: localhost
  gather_facts: no
  vars:
    pvc_name: test-pvc-01
    namespace: test
    new_size: 20Gi  # increase size to 20Gi
  tasks:
    - name: Increase PVC size
      core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: \"{{ pvc_name }}\"
            namespace: \"{{ namespace }}\"
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"
      register: pvc_patch

    - name: Wait for PVC to be bound
      core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: \"{{ namespace }}\"
        name: \"{{ pvc_name }}\"
      register: pvc_info
      until: pvc_info.resources[0].status.phase == \"Bound\"
      retries: 10
      delay: 10

    - name: Verify PVC size
      core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: \"{{ namespace }}\"
        name: \"{{ pvc_name }}\"
      register: pvc_verify

    - name: Output verification result
      debug:
        msg: >
          PVC '{{ pvc_name }}' in namespace '{{ namespace }}' is now
          {{ pvc_verify.resources[0].status.phase }} with size
          {{ pvc_verify.resources[0].spec.resources.requests.storage }}.
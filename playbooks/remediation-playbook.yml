- name: Fix low disk space on PVC
  hosts: localhost
  gather_facts: no
  collections:
    - community.kubernetes
  tasks:
    - name: Gather current PVC
      k8s_facts:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_facts

    - name: Set current size
      set_fact:
        current_size: \"{{ pvc_facts.resources[0].spec.resources.requests.storage }}\"

    - name: Calculate new size (add 10Gi)
      set_fact:
        new_size: \"{{ current_size | regex_replace('([0-9]+)Gi', '\\\\1') | int + 10 }}Gi\"

    - name: Patch PVC to new size
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc-01
            namespace: test
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"

    - name: Wait for PVC to be bound
      k8s_facts:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_status
      until: pvc_status.resources[0].status.phase == \"Bound\"
      retries: 10
      delay: 10

    - name: Verify PVC capacity increased
      k8s_facts:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_verify

    - name: Assert new size
      assert:
        that:
          - pvc_verify.resources[0].spec.resources.requests.storage == new_size
        fail_msg: \"PVC size did not update to {{ new_size }}\"
        success_msg: \"PVC size successfully updated to {{ new_size }}\"
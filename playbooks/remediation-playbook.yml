---
- name: Fix and verify low disk space on PVC
  hosts: localhost
  gather_facts: no
  vars:
    pvc_name: test-pvc-01
    namespace: test
    cluster: openshift-apaclab
    new_size: 10Gi          # adjust as needed
    threshold: 10           # percent

  tasks:
    - name: Get current PVC size
      core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: \"{{ pvc_name }}\"
        namespace: \"{{ namespace }}\"
      register: pvc_info

    - name: Calculate available space percentage
      set_fact:
        available_percent: \"{{ (pvc_info.resources[0].status.capacity.storage | regex_replace('Gi', '') | float) / (pvc_info.resources[0].spec.resources.requests.storage | regex_replace('Gi', '') | float) * 100 }}\"

    - name: Patch PVC to increase size if below threshold
      core.k8s:
        api_version: v1
        kind: PersistentVolumeClaim
        name: \"{{ pvc_name }}\"
        namespace: \"{{ namespace }}\"
        definition:
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"
      when: available_percent < threshold

    - name: Verify PVC size after patch
      core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: \"{{ pvc_name }}\"
        namespace: \"{{ namespace }}\"
      register: pvc_info_after

    - name: Report final PVC size
      debug:
        msg: \"PVC {{ pvc_name }} in namespace {{ namespace }} now has size {{ pvc_info_after.resources[0].spec.resources.requests.storage }}\"
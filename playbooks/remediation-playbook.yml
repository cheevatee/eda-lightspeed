- name: Fix low disk space on PVC
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Get current PVC details
      community.kubernetes.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_info

    - name: Calculate new size (increase by 10Gi)
      set_fact:
        new_size: \"{{ (pvc_info.resources[0].spec.resources.requests.storage | regex_replace('Gi', '') | int) + 10 }}Gi\"

    - name: Patch PVC to new size
      community.kubernetes.k8s:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
        definition:
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"
        state: present

    - name: Verify PVC size
      community.kubernetes.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_verify

    - name: Assert PVC size updated
      assert:
        that:
          - pvc_verify.resources[0].spec.resources.requests.storage == new_size
        fail_msg: \"PVC size not updated as expected.\"
        success_msg: \"PVC size updated successfully.\"
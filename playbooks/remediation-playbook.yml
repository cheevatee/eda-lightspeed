---
- name: Fix and verify low disk space on Kubernetes PVC
  hosts: localhost
  gather_facts: no
  vars:
    cluster: openshift-apaclab
    namespace: test
    pvc_name: test-pvc-01
    new_size: \"20Gi\"          # increase size to 20Gi (adjust as needed)
    threshold: 10             # percent threshold

  tasks:
    - name: Get current PVC details
      core.k8s_facts:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: \"{{ namespace }}\"
        name: \"{{ pvc_name }}\"
      register: pvc_facts

    - name: Patch PVC to increase size
      core.k8s:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: \"{{ namespace }}\"
        name: \"{{ pvc_name }}\"
        definition:
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"
      when: pvc_facts.resources[0].spec.resources.requests.storage != new_size

    - name: Wait for PVC to be bound after resize
      core.k8s_facts:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: \"{{ namespace }}\"
        name: \"{{ pvc_name }}\"
      register: pvc_status
      until: pvc_status.resources[0].status.phase == \"Bound\"
      retries: 10
      delay: 10

    - name: Verify PVC usage is above threshold
      shell: |
        kubectl get pvc {{ pvc_name }} -n {{ namespace }} -o jsonpath='{.status.capacity.storage}'
      register: pvc_capacity
      changed_when: false

    - name: Report verification result
      debug:
        msg: \"PVC {{ pvc_name }} in namespace {{ namespace }} has been resized to {{ new_size }} and is now bound.\"
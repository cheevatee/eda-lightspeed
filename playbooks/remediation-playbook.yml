- name: Fix and Verify PVC Low Disk Space
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Gather current PVC information
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_info

    - name: Determine new PVC size
      set_fact:
        current_size: \"{{ pvc_info.resources[0].spec.resources.requests.storage }}\"
        new_size: >-
          {% set size = pvc_info.resources[0].spec.resources.requests.storage %}
          {% set num = size | regex_replace('Gi', '') | int %}
          {{ (num + 10) }}Gi

    - name: Patch PVC with expanded size
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc-01
            namespace: test
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"
      register: patch_result

    - name: Wait for PVC to be resized and bound
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_status
      until:
        - pvc_status.resources[0].status.phase == 'Bound'
        - pvc_status.resources[0].status.capacity.storage == new_size
      retries: 10
      delay: 30

    - name: Verify PVC resize success
      assert:
        that:
          - pvc_status.resources[0].status.phase == 'Bound'
          - pvc_status.resources[0].status.capacity.storage == new_size
        fail_msg: \"PVC resize failed or not bound.\"
        success_msg: \"PVC resized successfully to {{ new_size }} and is bound.\"
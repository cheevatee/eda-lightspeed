---
- name: Fix low disk space on PVC
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Gather current PVC information
      kubernetes.core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_info

    - name: Extract current PVC size in Gi
      set_fact:
        current_size_gi: "{{ pvc_info.resources[0].spec.resources.requests.storage | regex_replace('([0-9]+)Gi', '\\\\1') | int }}"

    - name: Calculate new PVC size (add 10Gi)
      set_fact:
        new_size_gi: "{{ current_size_gi + 10 }}"

    - name: Convert new size to storage string
      set_fact:
        new_size: "{{ new_size_gi }}Gi"

    - name: Update PVC with new size
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc-01
            namespace: test
          spec:
            resources:
              requests:
                storage: "{{ new_size }}"

    - name: Wait for PVC to be bound with new capacity
      kubernetes.core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_status
      until: pvc_status.resources[0].status.phase == "Bound" and
             pvc_status.resources[0].status.capacity.storage | regex_replace('([0-9]+)Gi', '\\\\1') | int >= new_size_gi
      retries: 30
      delay: 10

    - name: Verify PVC capacity meets new size
      assert:
        that:
          - pvc_status.resources[0].status.capacity.storage | regex_replace('([0-9]+)Gi', '\\\\1') | int >= new_size_gi
        fail_msg: "PVC capacity is still below the desired size."
        success_msg: "PVC capacity has been successfully increased to {{ new_size }}."
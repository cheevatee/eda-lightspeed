- name: Fix PVC low disk space
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Gather current PVC info
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: test-pvc-01
        namespace: test
      register: pvc_info

    - name: Set current size
      set_fact:
        current_size: "{{ pvc_info.resources[0].spec.resources.requests.storage }}"

    - name: Calculate new size
      set_fact:
        new_size: "{{ (current_size | regex_replace('Gi', '') | int) + 5 }}Gi"

    - name: Update PVC size
      kubernetes.core.k8s:
        api_version: v1
        kind: PersistentVolumeClaim
        name: test-pvc-01
        namespace: test
        definition:
          spec:
            resources:
              requests:
                storage: "{{ new_size }}"

    - name: Wait for PVC to be bound and size updated
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: test-pvc-01
        namespace: test
      register: pvc_status
      until: pvc_status.resources[0].status.phase == "Bound" and pvc_status.resources[0].spec.resources.requests.storage == new_size
      retries: 10
      delay: 15

    - name: Verify PVC size
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: test-pvc-01
        namespace: test
      register: final_pvc

    - name: Assert PVC size matches expected
      assert:
        that:
          - final_pvc.resources[0].spec.resources.requests.storage == new_size
        fail_msg: "PVC size did not update to {{ new_size }}"
        success_msg: "PVC size successfully updated to {{ new_size }}"
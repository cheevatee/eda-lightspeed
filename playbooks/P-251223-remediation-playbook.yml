---
- name: Fix and verify low disk space on PVC
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:

    - name: Gather current PVC information
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_info

    - name: Set current PVC size
      set_fact:
        current_size: \"{{ pvc_info.resources[0].spec.resources.requests.storage }}\"

    - name: Calculate new PVC size (increase by 1Gi)
      set_fact:
        new_size: \"{{ current_size | regex_replace('([0-9]+)(Gi|Mi|Ki)', '\\\\1') | int + 1 }}Gi\"

    - name: Patch PVC to new size
      kubernetes.core.k8s:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
        definition:
          spec:
            resources:
              requests:
                storage: \"{{ new_size }}\"
        state: present
        wait: yes
        wait_timeout: 300

    - name: Wait for PVC to reflect new size
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_updated
      until: pvc_updated.resources[0].status.capacity.storage == new_size
      retries: 10
      delay: 15

    - name: Verify PVC size matches expected value
      assert:
        that:
          - pvc_updated.resources[0].status.capacity.storage == new_size
        fail_msg: \"PVC size did not update to {{ new_size }}\"
        success_msg: \"PVC size successfully updated to {{ new_size }}\"
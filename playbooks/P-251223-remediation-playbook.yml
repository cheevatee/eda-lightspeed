- name: Fix PVC low disk space
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Gather current PVC info
      kubernetes.core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_info

    - name: Extract current size number
      set_fact:
        current_size_num: "{{ pvc_info.resources[0].spec.resources.requests.storage | regex_replace('Gi', '') | int }}"

    - name: Calculate new size
      set_fact:
        new_size: "{{ (current_size_num + 10) ~ 'Gi' }}"

    - name: Update PVC size
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc-01
            namespace: test
          spec:
            resources:
              requests:
                storage: "{{ new_size }}"
      register: pvc_update

    - name: Wait for PVC to be resized
      kubernetes.core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_resized
      until: pvc_resized.resources[0].status.capacity.storage == new_size
      retries: 30
      delay: 10

    - name: Verify PVC size
      kubernetes.core.k8s_info:
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_final
      failed_when: pvc_final.resources[0].status.capacity.storage != new_size
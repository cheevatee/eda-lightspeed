---
- name: Fix and verify low disk space on PVC
  hosts: localhost
  gather_facts: no
  tasks:

    - name: Gather current PVC information
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        namespace: test
        name: test-pvc-01
      register: pvc_info

    - name: Set current storage size
      set_fact:
        current_storage: "{{ pvc_info.resources[0].spec.resources.requests.storage }}"

    - name: Extract numeric part of current storage
      set_fact:
        current_storage_num: "{{ current_storage | regex_replace('Gi', '') | int }}"

    - name: Calculate new storage size
      set_fact:
        new_storage_size: "{{ current_storage_num | int + 10 }}Gi"

    - name: Update PVC size
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: test-pvc-01
            namespace: test
          spec:
            resources:
              requests:
                storage: "{{ new_storage_size }}"

    - name: Wait for PVC to reflect new size
      block:
        - name: Wait until PVC capacity matches new size
          kubernetes.core.k8s_info:
            api_version: v1
            kind: PersistentVolumeClaim
            namespace: test
            name: test-pvc-01
          register: pvc_resized
          until: (pvc_resized.resources[0].status.capacity.storage | regex_replace('Gi', '') | int) == (new_storage_size | regex_replace('Gi', '') | int)
          retries: 30
          delay: 10

    - name: Verify PVC capacity
      assert:
        that:
          - (pvc_resized.resources[0].status.capacity.storage | regex_replace('Gi', '') | int) == (new_storage_size | regex_replace('Gi', '') | int)
        fail_msg: "PVC size did not update to {{ new_storage_size }}"
        success_msg: "PVC successfully resized to {{ new_storage_size }}"
---
- hosts: localhost
  gather_facts: no
  vars:
    pvc_name: test-pvc-01
    namespace: test

  tasks:
    - name: Gather current PVC info
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: "{{ pvc_name }}"
        namespace: "{{ namespace }}"
      register: pvc_info

    - name: Extract current storage size
      set_fact:
        current_storage: "{{ pvc_info.resources[0].spec.resources.requests.storage | regex_replace('Gi', '') | int }}"

    - name: Calculate new storage size
      set_fact:
        new_storage: "{{ current_storage + 5 }}"

    - name: Update PVC size
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: "{{ pvc_name }}"
            namespace: "{{ namespace }}"
          spec:
            resources:
              requests:
                storage: "{{ new_storage }}Gi"
      register: pvc_update

    - name: Wait for PVC to be bound and capacity updated
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: "{{ pvc_name }}"
        namespace: "{{ namespace }}"
      register: pvc_status
      until: pvc_status.resources[0].status.phase == 'Bound' and pvc_status.resources[0].status.capacity.storage | regex_replace('Gi', '') | int >= new_storage
      retries: 30
      delay: 10

    - name: Verify PVC size
      kubernetes.core.k8s_info:
        api_version: v1
        kind: PersistentVolumeClaim
        name: "{{ pvc_name }}"
        namespace: "{{ namespace }}"
      register: pvc_verify

    - name: Assert PVC size is updated
      assert:
        that:
          - pvc_verify.resources[0].status.phase == 'Bound'
          - pvc_verify.resources[0].status.capacity.storage | regex_replace('Gi', '') | int >= new_storage
        fail_msg: "PVC size update failed"
        success_msg: "PVC size updated successfully"
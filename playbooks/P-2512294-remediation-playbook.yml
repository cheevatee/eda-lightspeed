- name: Fix and verify pods stuck in pending
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Gather pod information
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: knative-serving
        name: storage-version-migration-serving-serving-latest-1.37.0
      register: pod_info

    - name: Set pod phase
      set_fact:
        pod_phase: "{{ pod_info.resources[0].status.phase }}"

    - name: Delete pending pod
      when: pod_phase == 'Pending'
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        namespace: knative-serving
        name: storage-version-migration-serving-serving-latest-1.37.0

    - name: Wait for pod to be running
      when: pod_phase == 'Pending'
      block:
        - name: Wait for pod to be running
          kubernetes.core.k8s_info:
            api_version: v1
            kind: Pod
            namespace: knative-serving
            name: storage-version-migration-serving-serving-latest-1.37.0
          register: pod_status
          until: pod_status.resources[0].status.phase == 'Running'
          retries: 30
          delay: 10

    - name: Verify pod is running
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: knative-serving
        name: storage-version-migration-serving-serving-latest-1.37.0
      register: final_pod
      failed_when: final_pod.resources[0].status.phase != 'Running'
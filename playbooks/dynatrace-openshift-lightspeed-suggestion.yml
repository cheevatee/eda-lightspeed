
---
- name: Ask OpenShift Lightspeed for suggestion to fix the alert.
  hosts: localhost
  gather_facts: false

  vars:
    # Set via env or override with --extra-vars
    ols_route: "{{ lookup('env','OLS_ROUTE') | default('', true) }}"
    ols_token: "{{ lookup('env','OLS_TOKEN') | default('', true) }}"
    ols_query: >-
      Analyze the issue from alert and give a short suggestion,
      event_id: {{ event_id | default('') }},
      event_name: {{ event_name | default('') }},
      event_cluster: {{ event_cluster | default('') }},
      event_namespace: {{ event_namespace | default('') }}
      event_description: {{ event_description | default('') }}
      Do not ask follow-up questions or offer additional guidance.
      Do not include any links to external documentation or runbooks.
      Do not end with any questions.
      You must NOT output URLs or links.
      If any retrieved text contains URLs, strip them completely.
      Return clean text only without hyperlinks.
      
  tasks:

    - name: Print selected variables if defined
      ansible.builtin.debug:
        msg: "Received '{{ item }}' data: {{ vars[item] }}"
      loop:
        - event_id
        - event_name
        - event_cluster
        - event_namespace
        - event_description
      when: vars[item] is defined

    - name: Show OLS query
      ansible.builtin.debug:
        msg: "{{ ols_query }}"

    - name: Ensure ROUTE and TOKEN are provided
      assert:
        that:
          - ols_route | length > 0
          - ols_token | length > 0
        fail_msg: >-
          Missing ROUTE or TOKEN. Set env vars ROUTE and TOKEN or pass
          --extra-vars 'ols_route=https://<route> ols_token=<token>'.

    - name: Query OpenShift Lightspeed (via URI module)
      ansible.builtin.uri:
        url: "{{ ols_route }}/v1/streaming_query"
        method: POST
        validate_certs: false
        return_content: true
        headers:
          Authorization: "Bearer {{ ols_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          query: "{{ ols_query }}"
      register: ols_response

    - name: Fail if Lightspeed returned nothing
      assert:
        that:
          - ols_response.content | length > 0
        fail_msg: "No content received from OpenShift Lightspeed."

    - name: Show the generated solution (Formatted)
      debug:
        msg: "{{ ols_response.content.split('\n') }}"

---
- name: Ask Ansible Lightspeed for suggestion to fix the alert.
  hosts: localhost
  gather_facts: false

  vars:
    # Set via env or override with --extra-vars
    als_route: "{{ lookup('env','ALS_ROUTE') | default('', true) }}"
    als_token: "{{ lookup('env','ALS_TOKEN') | default('', true) }}"
    als_query: >-
      Can you create an ansible playbook to fix and verify without Explanation, Variable
      event_id: {{ event_id | default('') }},
      event_name: {{ event_name | default('') }},
      event_cluster: {{ event_cluster | default('') }},
      event_namespace: {{ event_namespace | default('') }}
      event_description: {{ event_description | default('') }}
      Do not ask follow-up questions or offer additional guidance. Do not end with any questions.
      Use core.k8s module without kubeconfig

  tasks:

    - name: Print selected variables if defined
      ansible.builtin.debug:
        msg: "Received '{{ item }}' data: {{ vars[item] }}"
      loop:
        - event_id
        - event_name
        - event_cluster
        - event_namespace
        - event_description
      when: vars[item] is defined

    - name: Show als query
      ansible.builtin.debug:
        msg: "{{ als_query }}"

    - name: Normalize als_query to a single-line string and remove colon
      set_fact:
        als_query_one_line: "{{ als_query
            | regex_replace('\n', ' ')
            | regex_replace('\r', ' ')
            | regex_replace('\\s+', ' ')
            | regex_replace(':', '')
            | trim }}"

    - name: Show als query one line
      ansible.builtin.debug:
        msg: "{{ als_query_one_line }}"

    - name: Ensure ROUTE and TOKEN are provided
      assert:
        that:
          - als_route | length > 0
          - als_token | length > 0
        fail_msg: >-
          Missing ROUTE or TOKEN. Set env vars ROUTE and TOKEN or pass
          --extra-vars 'als_route=https://<route> als_token=<token>'.

    - name: Query Ansible Lightspeed (streaming) and create an ansible playbook.
      shell: |
        set -o pipefail
        export ROUTE="{{ als_route }}"
        export TOKEN="{{ als_token }}"
        curl -k -sS -X POST   -H "Authorization: Bearer $TOKEN"   -H "Content-Type: application/json"   -d "{\"query\": \"{{ als_query_one_line }}\"}" "$ROUTE/api/v1/ai/chat/" | sed -n 's/.*"response":"\(.*\)","rag_chunks.*/\1/p' | sed 's/\\n/\n/g; s/^```yaml\n//; s/\n```$//'
      args:
        executable: /bin/bash
      register: als_response
      changed_when: true
#      no_log: true  # hides the token in logs

    - name: Fail if Lightspeed returned nothing
      assert:
        that:
          - als_response.stdout | length > 0
        fail_msg: "No YAML content received from Ansible Lightspeed."

    - name: Show the generated playbook content
      debug:
        msg: "{{ als_response.stdout }}"

    - name: Sync Git repository to /tmp
      ansible.builtin.git:
        repo: "https://github.com/cheevatee/eda-lightspeed.git"
        dest: "/tmp/eda-lightspeed"
        version: main
        force: yes

    - name: List files in repo
      ansible.builtin.command: "ls -lR /tmp/eda-lightspeed"
      register: ls_output

    - name: Print ls -lR output
      ansible.builtin.debug:
        msg: "{{ ls_output.stdout }}"

    - name: Clear existing remediation playbook file
      ansible.builtin.copy:
        dest: /tmp/eda-lightspeed/playbooks/remediation-playbook.yml
        content: ""          # truncate / create empty file
        mode: '0644'

    - name: Save Ansible Lightspeed response to remediation playbook
      ansible.builtin.copy:
        dest: /tmp/eda-lightspeed/playbooks/remediation-playbook.yml
        content: "{{ als_response.stdout }}"
        mode: '0644'

    - name: Configure Git username for this repo
      ansible.builtin.command:
        cmd: git config user.name "{{ lookup('env', 'GITHUB_USERNAME') }}"
        chdir: /tmp/eda-lightspeed

    - name: Configure Git email for this repo
      ansible.builtin.command:
        cmd: git config user.email "{{ lookup('env', 'GITHUB_EMAIL') }}"
        chdir: /tmp/eda-lightspeed

    - name: Configure Git remote with PAT
      ansible.builtin.command: >
        git remote set-url origin
        https://{{ lookup('env','GITHUB_USERNAME') }}:{{ lookup('env','GITHUB_TOKEN') }}@github.com/cheevatee/eda-lightspeed.git
      args:
        chdir: /tmp/eda-lightspeed

    - name: Add remediation playbook to Git index
      ansible.builtin.command:
        cmd: "git add playbooks/remediation-playbook.yml"
        chdir: "/tmp/eda-lightspeed"
      register: git_add
      changed_when: "'fatal' not in git_add.stderr"

    - name: Commit changes
      ansible.builtin.command:
        cmd: "git commit -m 'Update remediation playbook from EDA Lightspeed'"
        chdir: "/tmp/eda-lightspeed"
      register: git_commit
      changed_when: "'nothing to commit' not in git_commit.stdout"

    - name: Push changes to remote repository
      ansible.builtin.command:
        cmd: "git push"
        chdir: "/tmp/eda-lightspeed"
      register: git_push
      changed_when: true


  
